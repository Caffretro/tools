#!/usr/bin/perl -w
use strict;
use POSIX 'strftime';

my $list = 1 if @ARGV && $ARGV[0] eq '-l';

my $baseurl = "https://ticket.grid.iu.edu";

$_ = `wget -qO- $baseurl/list/open`;

s/&nbsp;/ /g;

m{<thead>(.*?)</thead>}s;
my $hdr = $1;
$hdr =~ s{<input.*?/>}{}g;
my @hdrs = $hdr =~ m{<th>(.*?)</th>}g;
s/ /_/g for @hdrs;
my %hdridx = map {$hdrs[$_] => $_} 0 .. $#hdrs;

my $submit = $hdridx{Submit_Date};
my $owner = $hdridx{Assignees};
my $title = $hdridx{Title};
my $id = $hdridx{ID};

my $olddate = strftime "%F", localtime(time - 60*60*24*30);

my @software;
my @old;

while (m{<tr onclick="window.name = 'gocticket_list'(.*?)</tr>}gs) {
  my $tr = $1;
  my @tds = $tr =~ m{<td>(.*?)</td>}gs;
  if ($tds[$owner] =~ /Software Support/) {
    push @software, "$tds[$id]: $tds[$title]";
    push @old, "$tds[$id]: $tds[$title]" if $tds[$submit] lt $olddate;
  }
}

my $n_software = @software;
my $n_old = @old;

print "$n_software open Software Support ticket(s)\n";
if ($list) {
  print " - $baseurl/$_\n" for @software;
  print "\n";
}
print "$n_old Software Support ticket(s) open for over 30 days\n";
if ($list) {
  print " - $baseurl/$_\n" for @old;
}

